# docker-compose.yml
services:
  mysql:
    image: mysql:8.0
    container_name: balance-mysql
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: laravel_db
      MYSQL_USER: laravel
      MYSQL_PASSWORD: laravel
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - balance

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: balance-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: balance
      RABBITMQ_DEFAULT_PASS: balance
    ports:
      - "15672:15672" # UI dev
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - balance

  laravel-cli:
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: balance-laravel-cli
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: laravel_db
      DB_USERNAME: laravel
      DB_PASSWORD: laravel
      QUEUE_CONNECTION: rabbitmq
      RABBITMQ_URL: amqp://balance:balance@rabbitmq:5672/
    command: php artisan schedule:run
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - balance

  laravel-balance-scheduler:
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: balance-laravel-balance-scheduler
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: laravel_db
      DB_USERNAME: laravel
      DB_PASSWORD: laravel
    command: php artisan schedule:run
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - balance

  laravel-worker:
    build:
      context: ./
      dockerfile: Dockerfile
    container_name: balance-laravel-worker
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
    environment:
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: laravel_db
      DB_USERNAME: laravel
      DB_PASSWORD: laravel
      QUEUE_CONNECTION: database
    command: php artisan queue:work --sleep=1 --tries=3
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - balance

#  go-worker:
#    build:
#      context: ./go-service
#      dockerfile: Dockerfile
#    container_name: balance-go-worker
#    environment:
#      MYSQL_DSN: go:go@tcp(mysql:3306)/go_db?parseTime=true
#      RABBITMQ_URL: amqp://balance:balance@rabbitmq:5672/
#      RABBITMQ_QUEUE: balance_updates
#      SYNC_INTERVAL_SECONDS: 30
#      SYNC_BATCH_SIZE: 100
#    depends_on:
#      mysql:
#        condition: service_healthy
#      rabbitmq:
#        condition: service_healthy
#    restart: unless-stopped
#    networks:
#      - balance

volumes:
  mysql_data:
  rabbitmq_data:

networks:
  balance:
    driver: bridge
