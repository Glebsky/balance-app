# docker-compose.yml
x-laravel-base: &laravel-base
  build:
    context: ./
    dockerfile: Dockerfile
  working_dir: /var/www/html
  volumes:
    - ./:/var/www/html
    - /var/www/html/vendor
  environment:
    DB_CONNECTION: mysql
    DB_HOST: mysql
    DB_PORT: 3306
    DB_DATABASE: ${DB_DATABASE}
    DB_USERNAME: ${DB_USERNAME}
    DB_PASSWORD: ${DB_PASSWORD}
  depends_on:
    mysql:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
  networks:
    - balance
  restart: unless-stopped

services:
  mysql:
    image: mysql:8.0
    container_name: balance-mysql
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - balance

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: balance-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: balance
      RABBITMQ_DEFAULT_PASS: balance
    ports:
      - "15672:15672" # UI dev
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - balance

  laravel-balance-scheduler:
    <<: *laravel-base
    container_name: balance-laravel-scheduler
    command: php artisan schedule:work

  laravel-worker:
    <<: *laravel-base
    container_name: balance-laravel-worker
    environment:
      QUEUE_CONNECTION: database
    command: php artisan queue:work --sleep=1 --tries=3 --timeout=60 --max-jobs=1000

  go-worker:
   build:
     context: ./go-service
     dockerfile: Dockerfile
   container_name: balance-go-worker
   environment:
     DB_HOST: mysql
     DB_PORT: 3306
     RABBITMQ_HOST: rabbitmq
     DB_DATABASE: ${GO_DB_DATABASE}
     DB_USERNAME: ${GO_DB_USERNAME}
     DB_PASSWORD: ${GO_DB_PASSWORD}
     RABBITMQ_USER: ${RABBITMQ_USER}
     RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
     RABBITMQ_VHOST: /
     RABBITMQ_QUEUE: ${GO_RABBITMQ_QUEUE}
     RABBITMQ_PREFETCH: ${GO_RABBITMQ_PREFETCH}
     RABBITMQ_WORKERS: ${GO_RABBITMQ_WORKERS}
     BATCH_SIZE: ${GO_BATCH_SIZE}
     BATCH_INTERVAL_SECONDS: ${GO_BATCH_INTERVAL}
     SYNC_INTERVAL_SECONDS: ${GO_SYNC_INTERVAL}
     SYNC_BATCH_SIZE: ${GO_SYNC_BATCH_SIZE}
     RABBITMQ_PORT: 5672
   depends_on:
     mysql:
       condition: service_healthy
     rabbitmq:
       condition: service_healthy
   restart: unless-stopped
   networks:
     - balance

volumes:
  mysql_data:
  rabbitmq_data:

networks:
  balance:
    driver: bridge
